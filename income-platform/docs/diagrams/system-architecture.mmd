```mermaid
graph TB
    subgraph "Frontend Layer"
        WEB[Next.js 15 Web App<br/>React + TypeScript<br/>Tailwind + shadcn/ui]
        MOBILE[Mobile Web<br/>Responsive Design]
    end
    
    subgraph "API Gateway & Auth"
        GATEWAY[Next.js API Routes<br/>+ Supabase Auth]
        RLS[Row-Level Security<br/>Multi-Tenant Isolation]
    end
    
    subgraph "Orchestration Layer"
        direction LR
        N8N[n8n Workflows<br/>━━━━━━━━━━<br/>• Email ingestion<br/>• Webhook triggers<br/>• Simple integrations]
        PREFECT[Prefect Workflows<br/>━━━━━━━━━━<br/>• Daily pipeline<br/>• ML workflows<br/>• Complex orchestration]
    end
    
    subgraph "Agent Services Layer - FastAPI Microservices"
        direction TB
        
        subgraph "Data Agents"
            A1[Agent 1<br/>Market Data Sync<br/>yFinance + Alpaca]
            A2[Agent 2<br/>Newsletter Ingestion<br/>LLM Extraction]
        end
        
        subgraph "ML-Powered Agents"
            A3[Agent 3 ⭐<br/>Income Scoring<br/>XGBoost]
            A6[Agent 6<br/>Scenario Simulation<br/>ElasticNet GLM]
            A11[Agent 11 ⭐<br/>Alert Classification<br/>XGBoost]
        end
        
        subgraph "Analysis Agents"
            A4[Agent 4<br/>Entry Price<br/>Technical + Val]
            A5[Agent 5<br/>Tax Optimization<br/>Rules Engine]
            A7[Agent 7<br/>Opportunity Scanner<br/>Composite Score]
            A8[Agent 8<br/>Rebalancing<br/>CVXPY Optimization]
            A9[Agent 9<br/>Income Projection<br/>Div Forecast]
            A10[Agent 10<br/>NAV Monitor<br/>Trend Analysis]
        end
    end
    
    subgraph "Data Layer"
        SUPABASE[(Supabase<br/>━━━━━━━━━━<br/>Postgres 15<br/>+ pgvector<br/>+ Auth<br/>+ Realtime)]
        REDIS[(Redis Cache<br/>━━━━━━━━━━<br/>• Scores<br/>• Prices<br/>• Features)]
    end
    
    subgraph "External Services"
        YFINANCE[yFinance API<br/>Free Market Data]
        ALPACA[Alpaca Markets<br/>Trading Data]
        OPENAI[OpenAI API<br/>Embeddings + LLM]
        EMAIL[Email Provider<br/>IMAP/SMTP]
    end
    
    subgraph "Security & Monitoring"
        AUDIT[Audit Logging<br/>All Actions Tracked]
        SENTRY[Sentry<br/>Error Tracking]
        METRICS[Metrics Dashboard<br/>Performance + Costs]
    end
    
    %% Frontend connections
    WEB --> GATEWAY
    MOBILE --> GATEWAY
    GATEWAY --> RLS
    
    %% API to orchestration
    GATEWAY --> N8N
    GATEWAY --> PREFECT
    
    %% Orchestration to agents
    N8N --> A1
    N8N --> A2
    
    PREFECT --> A1
    PREFECT --> A3
    PREFECT --> A4
    PREFECT --> A5
    PREFECT --> A6
    PREFECT --> A7
    PREFECT --> A8
    PREFECT --> A9
    PREFECT --> A10
    PREFECT --> A11
    
    %% Agents to data layer
    A1 --> SUPABASE
    A2 --> SUPABASE
    A3 --> SUPABASE
    A3 --> REDIS
    A4 --> SUPABASE
    A5 --> SUPABASE
    A6 --> SUPABASE
    A7 --> SUPABASE
    A8 --> SUPABASE
    A9 --> SUPABASE
    A10 --> SUPABASE
    A11 --> SUPABASE
    
    %% External service connections
    A1 --> YFINANCE
    A1 --> ALPACA
    A2 --> OPENAI
    A2 --> EMAIL
    
    %% RLS to database
    RLS --> SUPABASE
    
    %% Monitoring connections
    SUPABASE --> AUDIT
    WEB --> SENTRY
    PREFECT --> METRICS
    N8N --> METRICS
    
    %% Realtime updates
    SUPABASE -.Realtime subscriptions.-> WEB
    
    %% Styling
    classDef frontend fill:#e1f5ff,stroke:#0277bd,stroke-width:2px
    classDef orchestration fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef agent fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef mlAgent fill:#c8e6c9,stroke:#388e3c,stroke-width:3px
    classDef data fill:#ffebee,stroke:#c62828,stroke-width:2px
    classDef external fill:#f5f5f5,stroke:#616161,stroke-width:1px
    classDef security fill:#fff9c4,stroke:#f57f17,stroke-width:2px
    
    class WEB,MOBILE frontend
    class N8N,PREFECT orchestration
    class A1,A2,A4,A5,A7,A8,A9,A10 agent
    class A3,A6,A11 mlAgent
    class SUPABASE,REDIS data
    class YFINANCE,ALPACA,OPENAI,EMAIL external
    class AUDIT,SENTRY,METRICS,GATEWAY,RLS security
```
