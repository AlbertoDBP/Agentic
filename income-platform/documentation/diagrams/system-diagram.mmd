flowchart TB
    subgraph External["External Data Sources"]
        SA["Seeking Alpha\nAPIDojo API"]
        FMP["Financial Modeling Prep\nMarket Truth"]
    end

    subgraph Agent02["Agent 02 — Newsletter Ingestion :8002"]
        direction TB
        subgraph Flows["Prefect Flows"]
            HF["Harvester Flow\nTue+Fri 7AM ET"]
            IF["Intelligence Flow\nMon 6AM ET"]
        end
        subgraph Processors["Processors"]
            EXT["Extractor\nClaude Haiku"]
            VEC["Vectorizer\nOpenAI Embeddings"]
            DED["Deduplicator\nSHA-256"]
            STALE["Staleness\nS-Curve Decay"]
            BT["Backtest\nT+30 / T+90"]
            PHI["Philosophy\nLLM + K-Means"]
            CON["Consensus\nWeighted Score"]
        end
        subgraph API["API Layer"]
            SIG["GET /signal/{ticker}\nAgent 12 Contract"]
            CONS["GET /consensus/{ticker}"]
            RECS["GET /recommendations/{ticker}"]
            ANA["GET /analysts"]
            HLTH["GET /health"]
        end
    end

    subgraph Storage["Platform Storage (platform_shared schema)"]
        PG[("PostgreSQL 16\n+ pgvector")]
        VK[("Valkey Cache\nRedis-compatible")]
    end

    subgraph Agent12["Agent 12 — Proposal Agent"]
        direction LR
        PA["Proposal\nAssembler"]
        AC["Alignment\nComputer"]
        VC["VETO\nChecker"]
    end

    subgraph Agents345["Platform Assessment Agents"]
        A03["Agent 03\nIncome Scorer"]
        A04["Agent 04\nEntry Price"]
        A05["Agent 05\nTax Placement"]
    end

    subgraph User["User Interface"]
        DASH["Dashboard\nProposal View"]
    end

    SA -->|"articles/v2/list\narticles/v2/get-details"| HF
    FMP -->|"price history\ndividend history"| BT

    HF --> EXT --> VEC --> DED
    DED --> PG
    IF --> STALE & BT & PHI & CON
    STALE & BT & PHI & CON --> PG

    PG --> SIG & CONS & RECS & ANA
    SIG & CONS --> VK

    SIG -->|"AnalystSignalResponse"| PA
    A03 & A04 & A05 -->|"score + entry + tax"| PA
    PA --> AC --> VC
    VC -->|"ProposalObject"| PG
    PG --> DASH

    classDef agent fill:#1a1a2e,stroke:#4a9eff,color:#fff
    classDef storage fill:#16213e,stroke:#4a9eff,color:#fff
    classDef external fill:#0f3460,stroke:#4a9eff,color:#fff
    classDef user fill:#533483,stroke:#9b72cf,color:#fff

    class Agent02,Agent12,Agents345 agent
    class Storage storage
    class External external
    class User user
