erDiagram

    SECURITIES {
        uuid id PK
        string ticker
        string name
        string detected_asset_class
        float class_confidence
        string data_sources_available
        timestamp last_classified_at
    }

    SCORES {
        uuid id PK
        uuid security_id FK
        int composite_score
        bool veto_triggered
        string veto_reason
        float income_sub_score
        float durability_sub_score
        float valuation_sub_score
        float technical_sub_score
        float total_risk_penalty
        json risk_flags
        json quality_gate_result
        json monte_carlo_result
        json tax_efficiency_metadata
        string recommendation
        float confidence
        string score_version
        string weight_set_used
        json class_weights_snapshot
        timestamp scored_at
    }

    SCORE_HISTORY {
        uuid id PK
        uuid score_id FK
        uuid security_id FK
        int composite_score
        bool veto_triggered
        string recommendation
        timestamp scored_at
        string trigger
    }

    NAV_EROSION_CACHE {
        uuid id PK
        uuid security_id FK
        float erosion_probability_12m
        float erosion_probability_24m
        float erosion_probability_36m
        string risk_tier
        float penalty_points
        int simulation_count
        json simulation_params
        timestamp computed_at
        timestamp expires_at
    }

    PREFERENCE_TABLE {
        uuid id PK
        string scope
        string asset_class
        string parameter_key
        float parameter_value
        string parameter_type
        string notes
        timestamp updated_at
    }

    SHADOW_PORTFOLIO {
        uuid id PK
        uuid security_id FK
        string rejection_reason
        json gate_failures
        int score_at_rejection
        float yield_at_rejection
        float yield_90d_later
        bool dividend_cut_occurred
        bool yield_trap_confirmed
        bool false_rejection
        timestamp rejected_at
        timestamp evaluated_at
    }

    WEIGHT_ADJUSTMENTS {
        uuid id PK
        string asset_class
        string adjustment_cycle
        json old_weights
        json new_weights
        float yield_accuracy_delta
        float trap_miss_rate_delta
        float false_rejection_rate_delta
        timestamp applied_at
    }

    SECURITIES ||--o{ SCORES : "scored as"
    SECURITIES ||--o{ SCORE_HISTORY : "history"
    SECURITIES ||--o{ NAV_EROSION_CACHE : "cached for"
    SECURITIES ||--o{ SHADOW_PORTFOLIO : "tracked in"
    SCORES ||--o{ SCORE_HISTORY : "archived to"
    WEIGHT_ADJUSTMENTS }o--|| PREFERENCE_TABLE : "updates"
